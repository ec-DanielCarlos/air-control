/**
 * @file HT_Fsm.c
 * @brief Aplicação MQTT com arquitetura de múltiplas tarefas para processar mensagens de diferentes tópicos.
 */

#include "HT_Fsm.h"
#include "HT_PWM.h"

#define SIGNAL_LEN 199
/* --- Configurações da Aplicação --- */
static const char BROKER_ADDR[]      = "131.255.82.115";
static const char CLIENT_ID[]        = "HTNB32L/dcamSubscriber222";

// Tópicos que vamos ouvir
static const char SUBSCRIBE_TOPIC_ESTADO[]      = "hana/externo/aircontrol/02/power";
static const char SUBSCRIBE_TOPIC_TEMPERATURA[] = "hana/externo/aircontrol/02/temperature";

/* --- Variáveis de Controle e Handles --- */
static MQTTClient mqttClient;
static Network mqttNetwork;
static uint8_t mqttSendbuf[HT_MQTT_BUFFER_SIZE] = {0};
static uint8_t mqttReadbuf[HT_MQTT_BUFFER_SIZE] = {0};

// Handles para as nossas "Caixas de Entrada" (Filas)
static osMessageQueueId_t estadoQueueHandle;
static osMessageQueueId_t temperaturaQueueHandle;

/* --- Protótipos de Funções --- */
static void OnMessageReceived_Dispatcher(MessageData *msg);
static void YieldTask(void *arg);
static void EstadoTask(void *arg);
static void TemperaturaTask(void *arg);

static volatile buffer_estado[64];


#define SIGNAL_LEN 199

// variaveis do pwm
static const uint16_t desligar[SIGNAL_LEN] = {6030, 7470, 480, 1720, 480, 1720, 480, 1670, 530, 1670, 480, 1670, 530, 1670, 480, 1670, 530, 1670, 530, 620, 480, 670, 480, 620, 480, 620, 480, 620, 530, 570, 530, 570, 530, 570, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 530, 1620, 530, 1670, 530, 1670, 480, 1670, 530, 620, 530, 570, 530, 570, 530, 620, 530, 620, 480, 620, 480, 620, 530, 570, 530, 1670, 530, 1670, 480, 1720, 480, 1670, 530, 1670, 480, 1670, 530, 1670, 530, 1670, 580, 570, 530, 570, 530, 620, 530, 620, 530, 570, 580, 570, 480, 620, 480, 670, 530, 1620, 580, 1620, 580, 1620, 480, 620, 530, 1670, 480, 1670, 530, 1670, 580, 1570, 580, 570, 580, 520, 480, 670, 580, 1620, 580, 570, 530, 570, 480, 620, 530, 570, 580, 1620, 580, 1620, 580, 1620, 480, 670, 530, 1670, 530, 1620, 580, 1620, 580, 1570, 530, 620, 480, 620, 530, 570, 580, 1570, 580, 570, 530, 570, 480, 620, 480, 620, 480, 620, 530, 1670, 530, 570, 480, 1770, 480, 620, 530, 1620, 530, 620, 530, 620, 480, 1720, 480, 620, 480, 1670, 480, 620, 530, 1670, 480, 620, 480, 1670, 480, 1670, 480, 7520, 430};
static const uint16_t gelar16[SIGNAL_LEN] = {6130, 7370, 530, 1620, 580, 1620, 580, 1620, 530, 1670, 580, 1570, 580, 1620, 580, 1620, 580, 1620, 530, 620, 480, 670, 530, 570, 530, 570, 580, 520, 580, 570, 480, 620, 480, 670, 530, 1620, 580, 1620, 580, 1620, 530, 1620, 580, 1570, 580, 1620, 580, 1620, 580, 1570, 580, 570, 580, 570, 480, 670, 530, 570, 580, 520, 580, 570, 480, 620, 530, 570, 580, 1620, 580, 1570, 630, 1570, 580, 1620, 580, 1620, 530, 1670, 480, 1720, 480, 1670, 530, 620, 580, 570, 530, 570, 430, 670, 580, 520, 580, 570, 580, 520, 530, 620, 480, 1670, 530, 570, 580, 1620, 530, 570, 530, 1620, 580, 1570, 580, 1620, 530, 1620, 580, 520, 480, 1770, 480, 570, 580, 1620, 580, 520, 580, 570, 480, 620, 480, 620, 530, 1670, 580, 1620, 580, 1570, 580, 1620, 480, 1720, 480, 1670, 480, 1670, 480, 1720, 530, 620, 530, 520, 580, 520, 580, 570, 430, 670, 480, 620, 530, 520, 580, 570, 530, 620, 480, 1670, 530, 620, 530, 1620, 530, 620, 480, 1670, 480, 620, 480, 620, 480, 1720, 530, 570, 530, 1620, 530, 620, 480, 1720, 480, 570, 530, 1670, 530, 1670, 480, 7420, 530};
static const uint16_t gelar17[SIGNAL_LEN] = {6180, 7320, 580, 1620, 580, 1620, 580, 1620, 580, 1570, 580, 1620, 580, 1620, 580, 1620, 580, 1570, 630, 520, 530, 570, 530, 570, 480, 620, 530, 620, 530, 570, 580, 570, 530, 570, 580, 1620, 480, 1720, 480, 1720, 480, 1670, 530, 1620, 530, 1670, 480, 1670, 580, 1570, 580, 570, 480, 620, 530, 570, 580, 520, 580, 570, 530, 620, 430, 670, 480, 620, 530, 1620, 580, 1620, 580, 1620, 530, 1670, 530, 1620, 580, 1620, 580, 1620, 480, 1720, 480, 620, 580, 520, 580, 520, 580, 520, 580, 570, 480, 620, 530, 570, 580, 520, 580, 1620, 580, 520, 530, 1670, 530, 570, 430, 1770, 530, 1620, 580, 1620, 580, 1620, 530, 570, 480, 1770, 480, 570, 580, 1620, 530, 570, 530, 620, 480, 620, 480, 620, 480, 670, 480, 1720, 480, 1670, 480, 1720, 480, 1670, 530, 1670, 530, 1670, 530, 1670, 480, 1670, 480, 670, 480, 620, 530, 570, 530, 570, 480, 670, 430, 670, 480, 620, 480, 620, 530, 1720, 430, 620, 480, 1720, 480, 670, 480, 1670, 480, 620, 480, 620, 480, 1770, 430, 620, 480, 1720, 480, 620, 480, 1670, 480, 620, 480, 1720, 430, 1720, 480, 7470, 430};
static const uint16_t gelar18[SIGNAL_LEN] = {6130, 7370, 580, 1620, 580, 1620, 580, 1620, 530, 1620, 480, 1670, 580, 1620, 580, 1620, 580, 1620, 580, 570, 580, 520, 580, 520, 580, 520, 580, 520, 580, 520, 530, 620, 480, 670, 530, 1620, 530, 1670, 480, 1670, 580, 1620, 580, 1620, 580, 1620, 580, 1620, 580, 1620, 580, 570, 480, 670, 530, 570, 630, 470, 580, 520, 580, 520, 580, 520, 580, 520, 580, 1620, 580, 1620, 580, 1570, 580, 1620, 580, 1620, 580, 1620, 580, 1620, 580, 1620, 530, 570, 580, 570, 480, 620, 480, 620, 480, 620, 480, 620, 530, 570, 580, 520, 580, 1620, 580, 520, 580, 1620, 580, 570, 530, 1670, 480, 1720, 430, 1770, 480, 1720, 480, 620, 580, 1620, 580, 520, 580, 1570, 580, 520, 580, 570, 580, 520, 530, 620, 430, 1770, 530, 570, 580, 1570, 580, 1620, 580, 1620, 580, 1620, 530, 1620, 530, 1620, 530, 620, 530, 1620, 530, 620, 530, 570, 480, 670, 480, 620, 480, 620, 480, 620, 480, 620, 530, 1670, 480, 620, 480, 1670, 480, 670, 480, 1720, 480, 620, 530, 570, 480, 1720, 480, 620, 480, 1720, 480, 620, 480, 1720, 480, 670, 430, 1770, 430, 1770, 430, 7520, 430};  
static const uint16_t gelar19[SIGNAL_LEN] = {6080, 7420, 530, 1670, 530, 1670, 530, 1670, 480, 1720, 530, 1620, 530, 1670, 480, 1670, 530, 1620, 530, 620, 530, 570, 530, 570, 530, 570, 530, 570, 530, 570, 530, 570, 530, 570, 580, 1620, 580, 1620, 530, 1670, 480, 1670, 580, 1620, 580, 1620, 580, 1620, 580, 1620, 530, 620, 530, 570, 580, 520, 580, 570, 530, 570, 580, 570, 530, 620, 480, 620, 430, 1770, 530, 1620, 580, 1620, 530, 1620, 580, 1620, 430, 1720, 530, 1620, 580, 1620, 580, 570, 530, 570, 530, 570, 580, 520, 580, 570, 480, 670, 430, 670, 480, 620, 530, 1670, 530, 620, 530, 570, 530, 1670, 530, 570, 530, 620, 530, 1670, 530, 1670, 530, 570, 530, 1670, 530, 1670, 530, 620, 480, 1720, 530, 1620, 530, 570, 480, 620, 530, 620, 480, 620, 480, 1720, 480, 1720, 480, 1720, 480, 620, 480, 1720, 480, 1720, 480, 1720, 480, 1720, 480, 670, 480, 620, 480, 620, 480, 1720, 480, 620, 480, 620, 480, 670, 480, 1720, 480, 620, 480, 1720, 430, 670, 480, 1720, 480, 620, 480, 620, 480, 1720, 480, 620, 480, 1720, 480, 670, 480, 1720, 480, 620, 480, 1670, 480, 1720, 480, 7470, 430};  
static const uint16_t gelar20[SIGNAL_LEN] = {6080, 7420, 530, 1670, 530, 1620, 530, 1620, 530, 1670, 530, 1620, 530, 1620, 530, 1670, 530, 1670, 580, 570, 530, 570, 580, 570, 530, 570, 530, 570, 530, 570, 530, 570, 580, 570, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 530, 1620, 530, 1670, 530, 620, 480, 620, 530, 570, 530, 570, 480, 620, 530, 570, 530, 620, 480, 620, 480, 1720, 480, 1670, 530, 1620, 580, 1620, 580, 1620, 580, 1620, 480, 1670, 480, 1720, 530, 570, 530, 570, 530, 620, 480, 620, 480, 620, 530, 620, 480, 620, 530, 570, 530, 1670, 530, 570, 530, 620, 530, 1670, 530, 570, 530, 520, 580, 1670, 530, 1620, 580, 570, 530, 1670, 530, 1670, 480, 620, 530, 1670, 530, 1670, 530, 620, 480, 620, 530, 1720, 480, 1720, 480, 620, 530, 1670, 530, 1670, 530, 570, 530, 1670, 530, 1670, 480, 620, 530, 620, 530, 1670, 480, 620, 480, 620, 530, 1670, 530, 570, 530, 570, 530, 620, 480, 1720, 480, 620, 480, 1720, 480, 620, 480, 1670, 530, 620, 480, 620, 530, 1720, 480, 570, 530, 1720, 480, 620, 480, 1720, 480, 670, 480, 1720, 430, 1720, 480, 7470, 480};  
static const uint16_t gelar21[SIGNAL_LEN] = {6080, 7420, 430, 1770, 530, 1670, 530, 1670, 530, 1670, 480, 1720, 430, 1720, 580, 1620, 530, 1670, 480, 620, 580, 570, 530, 570, 530, 570, 530, 570, 580, 520, 580, 520, 580, 520, 580, 1620, 480, 1720, 530, 1620, 580, 1620, 580, 1620, 530, 1670, 480, 1670, 530, 1670, 530, 620, 530, 570, 530, 570, 530, 570, 530, 620, 530, 570, 530, 570, 530, 570, 530, 1670, 530, 1620, 580, 1670, 530, 1620, 530, 1670, 430, 1720, 530, 1620, 580, 1620, 580, 570, 530, 570, 580, 520, 580, 570, 530, 570, 530, 620, 430, 670, 530, 570, 530, 1670, 530, 620, 530, 570, 530, 1670, 530, 570, 580, 570, 530, 1670, 530, 1620, 580, 570, 530, 1670, 530, 1670, 530, 570, 530, 1670, 530, 1670, 530, 570, 530, 620, 530, 570, 530, 1670, 530, 520, 580, 1620, 530, 1670, 530, 620, 530, 1670, 480, 1720, 480, 1720, 480, 620, 480, 1720, 480, 670, 480, 620, 480, 1720, 480, 670, 480, 670, 480, 620, 480, 1720, 480, 670, 480, 1720, 430, 670, 430, 1720, 480, 620, 480, 620, 480, 1720, 480, 620, 480, 1720, 480, 620, 480, 1770, 430, 670, 430, 1720, 430, 1720, 480, 7470, 430};  
static const uint16_t gelar22[SIGNAL_LEN] = {6130, 7370, 480, 1720, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 480, 1720, 530, 1670, 530, 1670, 530, 570, 580, 570, 530, 570, 580, 520, 580, 570, 580, 520, 530, 570, 530, 570, 580, 1620, 580, 1670, 530, 1670, 480, 1670, 530, 1670, 580, 1620, 580, 1620, 580, 1620, 530, 620, 530, 570, 530, 570, 530, 570, 530, 570, 580, 520, 580, 520, 530, 570, 580, 1620, 480, 1670, 580, 1620, 580, 1620, 580, 1620, 580, 1620, 580, 1620, 530, 1670, 430, 670, 480, 670, 480, 620, 530, 570, 580, 570, 530, 570, 530, 570, 580, 520, 580, 1620, 580, 520, 580, 570, 530, 1620, 580, 570, 530, 570, 530, 1670, 530, 1620, 530, 620, 530, 1670, 530, 1670, 530, 570, 530, 1670, 530, 1670, 530, 570, 580, 570, 530, 1670, 530, 570, 530, 620, 530, 1670, 530, 1620, 580, 570, 530, 1620, 580, 1620, 580, 570, 530, 1670, 530, 1670, 530, 570, 530, 570, 530, 1670, 530, 570, 530, 570, 530, 620, 480, 1670, 530, 570, 530, 1670, 530, 570, 530, 1670, 480, 620, 480, 670, 480, 1720, 480, 620, 480, 1670, 480, 620, 480, 1720, 480, 620, 480, 1720, 480, 1720, 480, 7470, 480}; 
static const uint16_t gelar23[SIGNAL_LEN] = {6080, 7370, 580, 1670, 480, 1670, 530, 1670, 530, 1670, 480, 1720, 480, 1670, 580, 1620, 580, 1620, 580, 570, 530, 570, 580, 520, 580, 570, 530, 570, 530, 570, 530, 570, 580, 570, 530, 1670, 530, 1670, 480, 1720, 430, 1720, 530, 1670, 530, 1670, 530, 1670, 480, 1720, 430, 670, 480, 670, 480, 620, 480, 620, 480, 620, 480, 620, 530, 570, 530, 570, 480, 1720, 480, 1670, 580, 1620, 580, 1620, 580, 1620, 580, 1620, 530, 1670, 530, 1670, 480, 670, 480, 620, 530, 570, 580, 570, 530, 570, 530, 570, 580, 520, 580, 570, 530, 1670, 530, 570, 530, 570, 530, 1670, 530, 570, 530, 570, 530, 1670, 530, 1670, 530, 620, 530, 1670, 530, 1670, 530, 570, 530, 1670, 530, 1670, 530, 620, 480, 620, 480, 620, 530, 620, 480, 670, 480, 1670, 480, 1720, 480, 670, 480, 1720, 480, 1670, 480, 1720, 480, 1720, 480, 1720, 480, 620, 480, 670, 480, 1720, 480, 620, 480, 620, 480, 670, 480, 1670, 480, 620, 480, 1720, 480, 670, 480, 1720, 480, 620, 480, 620, 430, 1770, 430, 670, 430, 1720, 430, 670, 480, 1720, 480, 620, 480, 1720, 480, 1720, 430, 7520, 430};
static const uint16_t gelar24[SIGNAL_LEN] = {5980, 7520, 430, 1720, 480, 1720, 480, 1720, 430, 1770, 430, 1720, 430, 1720, 480, 1770, 430, 1670, 480, 670, 530, 570, 480, 620, 480, 620, 480, 670, 430, 670, 430, 670, 430, 670, 480, 1720, 480, 1720, 480, 1670, 480, 1670, 530, 1720, 430, 1770, 480, 1720, 480, 1720, 430, 670, 480, 620, 480, 620, 480, 670, 480, 620, 480, 620, 480, 670, 480, 620, 480, 1720, 480, 1720, 480, 1720, 480, 1720, 480, 1720, 480, 1720, 430, 1720, 430, 1770, 430, 670, 480, 670, 480, 670, 430, 670, 480, 120, 130, 420, 480, 620, 480, 670, 430, 670, 480, 1720, 480, 1720, 480, 1720, 480, 620, 480, 1720, 480, 1720, 480, 1720, 480, 1720, 480, 620, 530, 620, 480, 670, 480, 1720, 430, 670, 430, 620, 480, 620, 480, 670, 430, 1770, 430, 1720, 430, 1720, 480, 670, 430, 1770, 430, 1720, 480, 1720, 480, 1720, 480, 620, 480, 620, 480, 620, 480, 1720, 430, 670, 430, 670, 430, 670, 480, 620, 480, 670, 480, 1670, 530, 620, 480, 1670, 530, 670, 430, 1670, 480, 720, 480, 620, 480, 1770, 430, 670, 480, 1670, 480, 670, 480, 1670, 480, 620, 480, 1670, 480, 1770, 430, 7470, 480};
static const uint16_t gelar25[SIGNAL_LEN] = {6080, 7420, 530, 1670, 530, 1620, 530, 1670, 530, 1620, 530, 1620, 530, 1670, 580, 1620, 580, 1620, 580, 570, 530, 570, 580, 520, 580, 520, 580, 520, 580, 570, 530, 570, 530, 570, 530, 1670, 530, 1670, 480, 1720, 480, 1720, 480, 1670, 580, 1620, 580, 1620, 580, 1620, 580, 570, 530, 570, 530, 570, 580, 520, 580, 570, 530, 570, 530, 620, 530, 570, 480, 1670, 580, 1620, 580, 1620, 580, 1620, 530, 1620, 480, 1670, 580, 1620, 530, 1620, 530, 620, 530, 570, 530, 570, 530, 620, 530, 570, 530, 570, 480, 670, 480, 670, 480, 1720, 480, 620, 480, 620, 530, 1670, 530, 570, 530, 570, 530, 1670, 530, 1620, 530, 620, 530, 1670, 480, 1720, 480, 670, 480, 1720, 480, 1720, 480, 620, 480, 670, 480, 620, 480, 1720, 480, 1720, 480, 670, 480, 1720, 480, 670, 480, 1720, 480, 1720, 480, 1720, 430, 670, 430, 670, 430, 1770, 430, 670, 480, 1720, 480, 620, 480, 620, 480, 670, 480, 1720, 480, 620, 480, 1720, 480, 620, 480, 1720, 480, 620, 480, 620, 430, 1770, 430, 670, 430, 1770, 430, 670, 430, 1770, 430, 670, 430, 1770, 380, 1770, 430, 7520, 380};
static const uint16_t gelar26[SIGNAL_LEN] = {6080, 7420, 530, 1670, 530, 1620, 530, 1620, 530, 1670, 580, 1620, 580, 1620, 580, 1620, 530, 1670, 430, 720, 480, 620, 480, 620, 430, 620, 480, 620, 530, 570, 480, 670, 480, 620, 430, 1770, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 480, 1720, 430, 670, 530, 570, 530, 570, 480, 620, 480, 620, 430, 670, 480, 670, 480, 620, 530, 1670, 480, 1720, 430, 1720, 530, 1620, 580, 1620, 530, 1670, 530, 1670, 430, 1720, 530, 570, 530, 570, 480, 670, 530, 620, 530, 570, 530, 570, 530, 620, 530, 570, 530, 1670, 530, 620, 530, 570, 530, 1670, 530, 570, 480, 670, 530, 1670, 480, 1670, 530, 620, 430, 1720, 530, 1670, 530, 570, 480, 1770, 480, 1670, 530, 570, 530, 570, 480, 1770, 430, 670, 530, 1670, 480, 620, 530, 1670, 480, 620, 580, 1620, 580, 1620, 580, 570, 530, 1620, 530, 570, 580, 1620, 530, 570, 530, 1670, 530, 570, 530, 570, 530, 620, 530, 1620, 580, 520, 580, 1620, 580, 520, 580, 1620, 530, 620, 480, 670, 480, 1720, 480, 620, 530, 1670, 530, 620, 530, 1670, 480, 620, 480, 1670, 480, 1720, 430, 7470, 480};  
static const uint16_t gelar27[SIGNAL_LEN] = {6080, 7420, 430, 1770, 530, 1670, 530, 1620, 580, 1670, 530, 1670, 480, 1670, 530, 1670, 530, 1670, 530, 570, 580, 520, 580, 570, 530, 570, 580, 520, 580, 520, 580, 570, 530, 570, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 480, 1720, 430, 1770, 480, 1670, 580, 570, 480, 670, 430, 670, 480, 620, 530, 570, 530, 620, 530, 570, 580, 520, 580, 1620, 580, 1620, 530, 1670, 430, 1720, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 530, 570, 530, 620, 530, 570, 530, 570, 480, 670, 480, 620, 480, 620, 480, 620, 480, 1720, 430, 670, 430, 670, 430, 1770, 430, 670, 530, 620, 530, 1670, 530, 1670, 530, 570, 580, 1620, 580, 1620, 580, 520, 580, 1620, 580, 1620, 580, 520, 530, 620, 530, 570, 530, 620, 530, 1670, 530, 620, 430, 1720, 480, 620, 480, 1720, 480, 1720, 480, 1720, 480, 1720, 480, 620, 480, 1720, 480, 620, 480, 1720, 480, 620, 480, 670, 480, 620, 530, 1670, 530, 620, 530, 1670, 480, 570, 530, 1670, 480, 620, 480, 620, 480, 1720, 480, 620, 480, 1720, 480, 620, 480, 1670, 480, 620, 480, 1670, 480, 1670, 480, 7470, 480};  
static const uint16_t gelar28[SIGNAL_LEN] = {6130, 7370, 480, 1720, 430, 1720, 580, 1620, 530, 1620, 480, 1670, 580, 1620, 580, 1620, 580, 1620, 480, 620, 530, 570, 530, 570, 480, 620, 480, 620, 530, 570, 530, 570, 530, 570, 530, 1670, 530, 1620, 580, 1670, 530, 1670, 430, 1720, 530, 1670, 530, 1620, 580, 1670, 530, 570, 530, 620, 530, 570, 530, 570, 530, 670, 480, 620, 430, 670, 430, 670, 530, 1670, 480, 1720, 430, 1770, 530, 1670, 530, 1620, 530, 1670, 530, 1620, 480, 1670, 530, 620, 480, 620, 480, 620, 480, 670, 530, 570, 580, 570, 530, 570, 530, 570, 580, 1620, 580, 1620, 530, 570, 530, 1670, 530, 620, 480, 620, 480, 1720, 480, 1720, 480, 620, 530, 620, 480, 1720, 480, 620, 480, 1720, 480, 1720, 480, 670, 480, 670, 480, 1720, 480, 1720, 430, 670, 480, 670, 430, 1770, 430, 670, 480, 1720, 480, 1720, 480, 620, 480, 620, 480, 1720, 480, 1720, 480, 620, 480, 1720, 480, 620, 480, 670, 430, 670, 480, 1720, 430, 720, 430, 1770, 430, 670, 430, 1770, 430, 670, 430, 720, 430, 1770, 430, 670, 430, 1770, 430, 720, 380, 1770, 430, 670, 430, 1770, 380, 1770, 380, 7570, 380};  
static const uint16_t gelar29[SIGNAL_LEN] = {6080, 7370, 580, 1620, 580, 1620, 580, 1670, 530, 1670, 430, 1720, 530, 1670, 530, 1670, 530, 1670, 480, 620, 530, 570, 530, 570, 480, 620, 480, 620, 430, 670, 480, 620, 530, 570, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 530, 1620, 430, 1770, 530, 1670, 530, 1670, 530, 570, 580, 520, 580, 520, 580, 570, 530, 570, 530, 570, 530, 570, 580, 520, 580, 1620, 580, 1620, 580, 1620, 580, 1620, 580, 1620, 480, 1670, 530, 1670, 530, 1620, 580, 570, 530, 570, 580, 520, 580, 520, 580, 570, 480, 670, 430, 670, 480, 620, 530, 1670, 530, 570, 530, 570, 480, 1720, 480, 620, 530, 620, 530, 1670, 480, 1670, 430, 720, 480, 1720, 480, 1670, 480, 620, 480, 1720, 480, 1720, 480, 670, 480, 620, 580, 570, 530, 1670, 530, 570, 580, 570, 530, 1670, 530, 570, 480, 1720, 480, 1720, 530, 1670, 530, 570, 530, 1670, 530, 1670, 530, 620, 480, 1720, 430, 720, 480, 620, 530, 570, 580, 1620, 580, 570, 530, 1670, 530, 570, 530, 1670, 530, 570, 530, 570, 530, 1670, 480, 670, 480, 1720, 480, 620, 480, 1720, 480, 570, 530, 1670, 480, 1670, 480, 7470, 480};  
static const uint16_t gelar30[SIGNAL_LEN] = {6130, 7370, 530, 1670, 480, 1720, 530, 1670, 530, 1670, 530, 1670, 430, 1720, 530, 1620, 530, 1670, 480, 620, 430, 720, 480, 620, 430, 670, 430, 620, 480, 620, 530, 570, 530, 570, 530, 1670, 580, 1620, 580, 1620, 580, 1620, 530, 1670, 430, 1720, 530, 1670, 580, 1620, 580, 570, 530, 570, 580, 520, 580, 520, 480, 720, 480, 620, 530, 570, 530, 570, 530, 1670, 480, 1720, 480, 1670, 580, 1620, 580, 1620, 530, 1620, 430, 1770, 480, 1670, 530, 620, 530, 570, 530, 570, 530, 570, 480, 670, 530, 620, 530, 570, 530, 570, 530, 1670, 530, 570, 530, 620, 530, 1670, 530, 520, 580, 520, 580, 1620, 580, 1620, 530, 570, 580, 1620, 580, 1620, 430, 670, 580, 1620, 530, 1670, 430, 670, 530, 620, 530, 1670, 530, 570, 580, 570, 530, 570, 530, 1670, 580, 570, 480, 1720, 480, 1720, 530, 620, 430, 1770, 430, 1770, 430, 1720, 480, 670, 530, 1670, 480, 620, 580, 570, 530, 570, 580, 1620, 580, 570, 530, 1670, 530, 570, 480, 1720, 530, 570, 480, 620, 480, 1720, 480, 670, 480, 1720, 480, 620, 530, 1670, 530, 570, 530, 1670, 480, 1670, 480, 7470, 480};  
static const uint16_t gelar31[SIGNAL_LEN] = {6080, 7420, 430, 1770, 530, 1670, 530, 1670, 530, 1670, 480, 1720, 480, 1670, 530, 1620, 530, 1620, 530, 620, 430, 720, 480, 620, 430, 670, 430, 620, 530, 620, 430, 670, 480, 620, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 530, 1620, 530, 1670, 530, 1670, 530, 620, 530, 570, 530, 570, 530, 570, 530, 620, 530, 570, 480, 620, 530, 570, 480, 1720, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 530, 1620, 530, 620, 430, 670, 480, 620, 430, 720, 480, 570, 530, 620, 530, 620, 530, 520, 580, 1620, 580, 520, 580, 570, 530, 1670, 530, 570, 530, 570, 580, 1620, 580, 1620, 580, 570, 530, 1670, 530, 1620, 580, 570, 530, 1670, 530, 1620, 480, 620, 530, 570, 530, 620, 530, 570, 580, 570, 530, 570, 580, 1620, 530, 570, 530, 1670, 530, 1670, 530, 1670, 530, 1620, 580, 1620, 580, 1620, 530, 570, 530, 1670, 530, 570, 580, 570, 530, 570, 580, 1620, 530, 570, 530, 1670, 530, 570, 530, 1670, 530, 620, 480, 620, 480, 1720, 480, 670, 480, 1670, 480, 620, 530, 1720, 430, 620, 530, 1720, 480, 1670, 480, 7470, 480};  
static const uint16_t gelar32[SIGNAL_LEN] = {6080, 7420, 480, 1720, 480, 1720, 530, 1620, 580, 1670, 530, 1670, 430, 1720, 530, 1670, 580, 1620, 580, 570, 530, 570, 580, 570, 530, 570, 580, 520, 580, 570, 530, 570, 530, 570, 530, 1670, 530, 1670, 530, 1670, 530, 1620, 530, 1670, 530, 1670, 530, 1670, 480, 1720, 480, 620, 530, 570, 480, 620, 430, 670, 430, 720, 480, 620, 480, 620, 480, 620, 530, 1670, 480, 1720, 480, 1720, 530, 1670, 530, 1670, 530, 1670, 530, 1670, 530, 1620, 480, 670, 480, 620, 530, 620, 530, 570, 530, 570, 530, 570, 530, 620, 530, 570, 530, 1670, 530, 570, 530, 570, 530, 1670, 530, 570, 530, 570, 530, 1670, 530, 1670, 530, 570, 530, 1670, 530, 1720, 480, 570, 530, 1670, 530, 1670, 530, 620, 480, 620, 480, 1720, 480, 1720, 480, 1720, 480, 1670, 480, 670, 480, 570, 480, 1720, 480, 1720, 480, 670, 480, 620, 480, 670, 480, 620, 480, 1720, 480, 1720, 480, 620, 480, 670, 480, 620, 480, 1720, 480, 620, 480, 1720, 430, 670, 480, 1720, 480, 670, 430, 670, 430, 1770, 430, 670, 430, 1770, 430, 670, 430, 1770, 430, 670, 430, 1770, 430, 1770, 430, 7470, 480};  






/**
 * @brief A "Recepcionista". Chamada para TODAS as mensagens.
 * Ela verifica o tópico e encaminha a mensagem para a fila correta.
 */
static void OnMessageReceived_Dispatcher(MessageData *msg) {
    if (msg == NULL || msg->message == NULL || msg->message->payload == NULL) return;

    // Verifica se a mensagem é do tópico de ESTADO
    if (strncmp(msg->topicName->lenstring.data, SUBSCRIBE_TOPIC_ESTADO, msg->topicName->lenstring.len) == 0) {
        // Envia o payload para a fila da tarefa de estado
        uint8_t teste[100] = {0}; 
        memcpy(teste,msg->message->payload,msg->message->payloadlen);
        // printf("SUBSCRIBE_TOPIC_ESTADO: %s\n",teste);
        osMessageQueuePut(estadoQueueHandle, teste, 0, 0);
        memset(msg->message->payload,0,msg->message->payloadlen);
    } 
    // Verifica se a mensagem é do tópico de TEMPERATURA
    else if (strncmp(msg->topicName->lenstring.data, SUBSCRIBE_TOPIC_TEMPERATURA, msg->topicName->lenstring.len) == 0) {
        // Envia o payload para a fila da tarefa de temperatura
        uint8_t teste[100] = {0};
        memcpy(teste,msg->message->payload,msg->message->payloadlen);
        // printf("SUBSCRIBE_TOPIC_ESTADO: %s\n",teste);
        // printf("SUBSCRIBE_TOPIC_TEMPERATURA: %s\n",msg->message->payload);
        osMessageQueuePut(temperaturaQueueHandle, msg->message->payload, 0, 0);
        memset(msg->message->payload,0,msg->message->payloadlen);
    }
}


/**
 * @brief A "Telefonista". Mantém a conexão viva em segundo plano.
 */
static void YieldTask(void *arg) {
    int rc = 0;
    while (1) {
        MQTTYield(&mqttClient, 1000);
        // MQTTYield é o coração da manutenção da conexão.
        // Ela retorna 0 para sucesso e um código de erro em caso de falha.
        // Se MQTTYield retornar um erro, significa que a conexão foi perdida.
        if (MQTTYield(&mqttClient, 1000) == FAILURE) {
            printf("[YieldTask] ERRO: MQTTYield retornou o codigo %d. A conexão caiu.\n", rc);
            printf("[YieldTask] A reiniciar o sistema para restabelecer a ligacao...\n");
            
            osDelay(2000); // Espera 2 segundos para garantir que o log foi enviado.
            NVIC_SystemReset(); // Força uma reinicialização do sistema.
        }
    }
}

/**
 * @brief Tarefa Especialista 1: Processa apenas mensagens de ESTADO.
 */
static void EstadoTask(void *arg) {

    while (1) {
        // A tarefa "dorme" aqui, esperando uma mensagem na sua fila específica
        if (osMessageQueueGet(estadoQueueHandle, buffer_estado, NULL, osWaitForever) == osOK) {
            printf(">>> [TAREFA DE ESTADO] Processando mensagem: %s\n", buffer_estado);
            // Aqui entraria a lógica para tratar o estado (ex: ligar/desligar algo)
            osDelay(pdMS_TO_TICKS(100));
        }
    }
}

/**
 * @brief Tarefa Especialista 2: Processa apenas mensagens de TEMPERATURA.
 */
static void TemperaturaTask(void *arg) {
    char buffer_temperatura[64];
    uint8_t volatile numSwit = 0;

    while (1) {
        // A tarefa "dorme" aqui, esperando uma mensagem na sua fila específica
        if (osMessageQueueGet(temperaturaQueueHandle, buffer_temperatura, NULL, osWaitForever) == osOK) {
            printf(">>> [TAREFA DE TEMPERATURA] Processando mensagem: %s\n", buffer_temperatura);
            // Aqui entraria a lógica para tratar a temperatura (ex: ajustar um ar condicionado)


            // if((strcmp(buffer_temperatura,"OFF")) == 0)
            // {
            //     printf("teste\n");
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(desligar[i]);
                        
            //         else
            //             start_pwm(desligar[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aquioff");  
            // }

            // else if(strcmp(buffer_temperatura,"ON") == 0)
            // {
            //     printf("teste2\n");
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(gelar24[i]);
                        
            //         else
            //             start_pwm(gelar24[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aqui24");
            // }

            if(strcmp(buffer_estado,"ON")== 0)
            {

        

                if(strcmp(buffer_temperatura,"17") == 0)
                {
                    printf("aqui17_1\n");
                    for (uint16_t i = 0; i < SIGNAL_LEN; i++)
                    {
                        if ( i & 1 )
                            stop_pwm(gelar17[i]);
                            
                        else
                            start_pwm(gelar17[i]);
                    }
                    stop_pwm(0);
                    printf("aqui17_2\n");
                }

                else if(strcmp(buffer_temperatura,"18") == 0)
                {

                    for (uint16_t i = 0; i < SIGNAL_LEN; i++)
                    {
                        if ( i & 1 )
                            stop_pwm(gelar18[i]);
                            
                        else
                            start_pwm(gelar18[i]);
                    }
                    stop_pwm(0);
                    printf("aqui18");
                }
                
                else if(strcmp(buffer_temperatura,"19") == 0)
                {
                    for (uint16_t i = 0; i < SIGNAL_LEN; i++)
                    {
                        if ( i & 1 )
                            stop_pwm(gelar19[i]);
                            
                        else
                            start_pwm(gelar19[i]);
                    }
                    stop_pwm(0);
                    printf("aqui19");
                }

                else if(strcmp(buffer_temperatura,"20") == 0)
                {
                    for (uint16_t i = 0; i < SIGNAL_LEN; i++)
                    {
                        if ( i & 1 )
                            stop_pwm(gelar20[i]);
                            
                        else
                            start_pwm(gelar20[i]);
                    }
                    stop_pwm(0);
                    printf("aqui20");
                }

                else if(strcmp(buffer_temperatura,"21") == 0)
                {
                    for (uint16_t i = 0; i < SIGNAL_LEN; i++)
                    {
                        if ( i & 1 )
                            stop_pwm(gelar21[i]);
                            
                        else
                            start_pwm(gelar21[i]);
                    }
                    stop_pwm(0);
                    printf("aqui21");
                }

                else if(strcmp(buffer_temperatura,"22") == 0)
                {
                    for (uint16_t i = 0; i < SIGNAL_LEN; i++)
                    {
                        if ( i & 1 )
                            stop_pwm(gelar22[i]);
                            
                        else
                            start_pwm(gelar22[i]);
                    }
                    stop_pwm(0);
                    printf("aqui22");
                }

                else if(strcmp(buffer_temperatura,"23") == 0)
                {
                    for (uint16_t i = 0; i < SIGNAL_LEN; i++)
                    {
                        if ( i & 1 )
                            stop_pwm(gelar23[i]);
                            
                        else
                            start_pwm(gelar23[i]);
                    }
                    stop_pwm(0);
                    printf("aqui23");
                }

                else if(strcmp(buffer_temperatura,"24") == 0)
                {
                    for (uint16_t i = 0; i < SIGNAL_LEN; i++)
                    {
                        if ( i & 1 )
                            stop_pwm(gelar24[i]);
                            
                        else
                            start_pwm(gelar24[i]);
                    }
                    stop_pwm(0);
                    printf("aqui24");
                }

                else if(strcmp(buffer_temperatura,"25") == 0)
                {
                    for (uint16_t i = 0; i < SIGNAL_LEN; i++)
                    {
                        if ( i & 1 )
                            stop_pwm(gelar25[i]);
                            
                        else
                            start_pwm(gelar25[i]);
                    }
                    stop_pwm(0);
                    printf("aqui25");
                }

                else if(strcmp(buffer_temperatura,"26") == 0)
                {
                    for (uint16_t i = 0; i < SIGNAL_LEN; i++)
                    {
                        if ( i & 1 )
                            stop_pwm(gelar26[i]);
                            
                        else
                            start_pwm(gelar26[i]);
                    }
                    stop_pwm(0);
                    printf("aqui26");
                }

                else if(strcmp(buffer_temperatura,"27") == 0)
                {
                    for (uint16_t i = 0; i < SIGNAL_LEN; i++)
                    {
                        if ( i & 1 )
                            stop_pwm(gelar27[i]);
                            
                        else
                            start_pwm(gelar27[i]);
                    }
                    stop_pwm(0);
                    printf("aqui27");
                }

                else if(strcmp(buffer_temperatura,"28") == 0)
                {
                    for (uint16_t i = 0; i < SIGNAL_LEN; i++)
                    {
                        if ( i & 1 )
                            stop_pwm(gelar28[i]);
                            
                        else
                            start_pwm(gelar28[i]);
                    }
                    stop_pwm(0);
                    printf("aqui28");
                }

                else if(strcmp(buffer_temperatura,"29") == 0)
                {
                    for (uint16_t i = 0; i < SIGNAL_LEN; i++)
                    {
                        if ( i & 1 )
                            stop_pwm(gelar29[i]);
                            
                        else
                            start_pwm(gelar29[i]);
                    }
                    stop_pwm(0);
                    printf("aqui29");
                }

                else if(strcmp(buffer_temperatura,"30") == 0)
                {
                    for (uint16_t i = 0; i < SIGNAL_LEN; i++)
                    {
                        if ( i & 1 )
                            stop_pwm(gelar30[i]);
                            
                        else
                            start_pwm(gelar30[i]);
                    }
                    stop_pwm(0);
                    printf("aqui30");
                }

                else if(strcmp(buffer_temperatura,"31") == 0)
                {
                    for (uint16_t i = 0; i < SIGNAL_LEN; i++)
                    {
                        if ( i & 1 )
                            stop_pwm(gelar31[i]);
                            
                        else
                            start_pwm(gelar31[i]);
                    }
                    stop_pwm(0);
                    printf("aqui31");
                }

                else if(strcmp(buffer_temperatura,"32") == 0)
                {
                    for (uint16_t i = 0; i < SIGNAL_LEN; i++)
                    {
                        if ( i & 1 )
                            stop_pwm(gelar32[i]);
                            
                        else
                            start_pwm(gelar32[i]);
                    }
                    stop_pwm(0);
                    printf("aqui32");
                }

                else{
                    printf("digita certo ai lek\n");
                }
            }
            else
            {
                printf("O ar condicionado ta desligado:");
            }

            // switch (numSwit)
            // {
            // case 1 :
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(desligar[i]);
                        
            //         else
            //             start_pwm(desligar[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aquioff");                
            // break;

            // case 17 :
            //     printf("aqui17_1");
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(gelar17[i]);
                        
            //         else
            //             start_pwm(gelar17[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aqui17");
            // break;

            // case 18 :
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(gelar18[i]);
                        
            //         else
            //             start_pwm(gelar18[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aqui18");
            // break;
                
            // case 19:
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(gelar19[i]);
                        
            //         else
            //             start_pwm(gelar19[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aqui19");
            // break;
                
            // case 20 :
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(gelar20[i]);
                        
            //         else
            //             start_pwm(gelar20[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aqui20");
            // break;
                
            // case 21 :
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(gelar21[i]);
                        
            //         else
            //             start_pwm(gelar21[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aqui21");
            // break;
                
            // case 22 :
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(gelar22[i]);
                        
            //         else
            //             start_pwm(gelar22[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aqui22");
            // break;
                
            // case 23 : 
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(gelar23[i]);
                        
            //         else
            //             start_pwm(gelar23[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aqui23");
            // break;
                
            // case 24 :
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(gelar24[i]);
                        
            //         else
            //             start_pwm(gelar24[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aqui24");
            // break;
                
            // case 25 :
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(gelar25[i]);
                        
            //         else
            //             start_pwm(gelar25[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aqui25");
            // break;
                
            // case 26 :
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(gelar26[i]);
                        
            //         else
            //             start_pwm(gelar26[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aqui26");
            // break;
                
            // case 27 :
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(gelar27[i]);
                        
            //         else
            //             start_pwm(gelar27[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aqui27");
            // break;
                
            // case 28 :
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(gelar28[i]);
                        
            //         else
            //             start_pwm(gelar28[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aqui28");
            // break;
                
            // case 29 :
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(gelar29[i]);
                        
            //         else
            //             start_pwm(gelar29[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aqui29");
            // break;
                
            // case 30 :
            //     for (uint16_t i = 0; i < SIGNAL_LEN; i++)
            //     {
            //         if ( i & 1 )
            //             stop_pwm(gelar30[i]);
                        
            //         else
            //             start_pwm(gelar30[i]);
            //     }
            //     stop_pwm(0);
            //     printf("aqui30");
            // break;
                
            // default:
            //     break;
            // }
            osDelay(pdMS_TO_TICKS(100));
        }
    }
}

/**
 * @brief Função principal da lógica. Inicia a conexão e todas as tarefas.
 */
void HT_Fsm(void) {

    
    // Cria as "Caixas de Entrada" (Filas) para cada tarefa especialista
    estadoQueueHandle = osMessageQueueNew(5, sizeof(char[64]), NULL);      // Fila para 5 mensagens de estado
    temperaturaQueueHandle = osMessageQueueNew(5, sizeof(char[64]), NULL); // Fila para 5 mensagens de temperatura

    // 1. Conecta ao Broker MQTT
    if (HT_MQTT_Connect(&mqttClient, &mqttNetwork, (char *)BROKER_ADDR, HT_MQTT_PORT, HT_MQTT_TIMEOUT, HT_MQTT_TIMEOUT,
                        (char *)CLIENT_ID, NULL, NULL, HT_MQTT_VERSION, HT_MQTT_KEEP_ALIVE_INTERVAL,
                        mqttSendbuf, HT_MQTT_BUFFER_SIZE, mqttReadbuf, HT_MQTT_BUFFER_SIZE) != 0) {
        printf("ERRO FATAL: Nao foi possivel conectar ao Broker MQTT.\n");
        while(1) osDelay(5000);
    }
    printf("Conectado ao Broker MQTT com sucesso!\n");

    // 2. Inscreve-se nos DOIS tópicos, usando a mesma função "Recepcionista"
    printf("Inscrevendo-se nos topicos...\n");
    // MQTTSubscribe(&mqttClient, SUBSCRIBE_TOPIC_ESTADO, QOS0, OnMessageReceived_Dispatcher);
    MQTTSubscribe(&mqttClient, SUBSCRIBE_TOPIC_TEMPERATURA, QOS0, OnMessageReceived_Dispatcher);
    printf("Inscricoes realizadas.\n\n");

    // 3. Inicia todas as tarefas necessárias
    osThreadAttr_t task_attr;
    
    // Tarefa Telefonista (Yield)
    memset(&task_attr, 0, sizeof(task_attr));
    task_attr.name = "YieldTask";
    task_attr.stack_size = 2048;
    task_attr.priority = osPriorityNormal;
    osThreadNew(YieldTask, NULL, &task_attr);

    // Tarefa Especialista de Estado
    memset(&task_attr, 0, sizeof(task_attr));
    task_attr.name = "EstadoTask";
    task_attr.stack_size = 2048;
    task_attr.priority = osPriorityNormal;
    osThreadNew(EstadoTask, NULL, &task_attr);

    //Tarefa Especialista de Temperatura
    memset(&task_attr, 0, sizeof(task_attr));
    task_attr.name = "TemperaturaTask";
    task_attr.stack_size = 1024 * 5;
    task_attr.priority = osPriorityNormal;
    osThreadNew(TemperaturaTask, NULL, &task_attr);

    printf("Sistema pronto. Todas as tarefas estao rodando em paralelo.\n");
    while (1)
    {
        osDelay(pdMS_TO_TICKS(10000000000000));
    }
    printf("Nõ deve chegar aqui!");
    // Deleta a tarefa atual para liberar recursos, pois ela já fez seu trabalho.
    osThreadTerminate(osThreadGetId());
}